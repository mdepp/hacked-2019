<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      
      var stories = [
        { location: {lat: -31.563910, lng: 147.154312}, text: 'Story text... <a href="#" onclick="console.log(click);">Link</a>' },
        { location: {lat: 56.1304, lng: 106.3468}, text: 'Story text 2...' }
      ]
      var map;
      var infowindow;
      var markers = null;

      const http = new XMLHttpRequest();
      const api_url = 'http://localhost:5000/all/';
      http.open('GET', api_url);
      http.send();
      http.onreadystatechange=(e)=>{
        if (http.readyState != 4 || http.status != 200) return;
        console.log('Fetched data.');
        stories = []
        let response = JSON.parse(http.responseText);
        for (let key in response) {
          if (!response.hasOwnProperty(key)) continue;
          let data = response[key];
          stories.push({
            location: {lat: data['lat'], lng: data['lon']},
            text: data['content'].substring(0, 100)
          });
        }
        refreshMarkersAndInfo();
      }

      function refreshMarkersAndInfo() {
        // Delete existing markers
        if (markers != null) {
          for (let marker of markers) {
            marker.setMap(null);
          }
        }
        // Add markers for each story
        markers = stories.map(function(story, i) {
          return new google.maps.Marker({
            position: story.location,
            map: map
          });
        });
        // Add event listeners to open info windows
        for (let i=0; i < stories.length; i++) {
          markers[i].addListener('click', function() {
            showInfoWindow(markers[i], stories[i], infoWindow);
          });
        }
      }

      function showInfoWindow(marker, story, info) {
        console.log(infoWindow);
        info.setContent(story.text);
        info.open(map, marker);
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 1
        });
        infoWindow = new google.maps.InfoWindow({});
        console.log(infoWindow);
        
        refreshMarkersAndInfo();
        // Add a marker clusterer to manage the markers.
        // var markerCluster = new MarkerClusterer(map, markers, {imagePath: 'libraries/markerclusterer/m'});

        
      }
    </script>
    <script src="libraries/markerclusterer/markerclusterer.js">
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASmcQamr1iQSau43ljRPxorWq-RCt5gyA&callback=initMap"
    async defer></script>
  </body>
</html>